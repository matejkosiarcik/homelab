name: ExampleBuild

permissions: read-all

on:
  pull_request:

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.filter.outputs.changes }}
      # pihole: ${{ steps.filter.outputs.pihole }}
      # gatus: ${{ steps.filter.outputs.gatus }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7

      - name: Filter paths
        uses: dorny/paths-filter@v3.0.2
        id: filter
        with:
          filters: |
            pihole:
              - '**/pihole*/**'
            gatus:
              - '**/gatus*/**'

      - name: pihole tests
        if: steps.filter.outputs.pihole == 'true'
        run: echo "pihole changes"

      - name: not pihole tests
        if: steps.filter.outputs.pihole != 'true'
        run: echo "NOT pihole changes"

      - name: gatus tests
        if: steps.filter.outputs.gatus == 'true'
        run: echo "gatus changes"

      - name: not gatus tests
        if: steps.filter.outputs.gatus != 'true'
        run: echo "NOT gatus changes"

  build:
    runs-on: ubuntu-latest
    needs: paths-filter
    # if: needs.paths-filter.outputs.${{ matrix.component }} == 'true'
    strategy:
      # fail-fast: false
      matrix:
        # Parse JSON array containing names of all filters matching any of changed files
        # e.g. ['package1', 'package2'] if both package folders contains changes
        component: ${{ fromJSON(needs.paths-filter.outputs.components) }}
        # component:
        #   - pihole
        #   - gatus
        architecture:
          - amd64
          - arm64
    name: Build - ${{ matrix.component }} - linux/${{ matrix.architecture }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7

      # - name: jobdebug
      #   if: job.needs.paths-filter.outputs.${{ matrix.component }} == 'true'
      #   run: echo "Component ${{ matrix.component }} changes"

      # - name: Filter paths
      #   uses: dorny/paths-filter@v3.0.2
      #   id: filter
      #   with:
      #     filters: |
      #       pihole:
      #         - '**/pihole*/**'
      #       gatus:
      #         - '**/gatus*/**'

      # - name: workflow tests
      #   if: steps.filter.outputs.${{ matrix.component }} == 'true'
      #   run: echo "Workflow changes"

      # - name: not workflow tests
      #   if: steps.filter.outputs.${{ matrix.component }} != 'true'
      #   run: echo "NOT workflow changes"

      # - name: pihole tests
      #   if: steps.filter.outputs.pihole == 'true'
      #   run: echo "pihole changes"

      # - name: not pihole tests
      #   if: steps.filter.outputs.pihole != 'true'
      #   run: echo "NOT pihole changes"

      # - name: gatus tests
      #   if: steps.filter.outputs.gatus == 'true'
      #   run: echo "gatus changes"

      # - name: not gatus tests
      #   if: steps.filter.outputs.gatus != 'true'
      #   run: echo "NOT gatus changes"

      - name: Setup QEMU
        # if: steps.filter.outputs.${{ matrix.component }} == 'true'
        uses: docker/setup-qemu-action@v3.2.0

      - name: Setup Docker Buildx
        # if: steps.filter.outputs.${{ matrix.component }} == 'true'
        uses: docker/setup-buildx-action@v3.6.1

      - name: Example build
        # if: steps.filter.outputs.${{ matrix.component }} == 'true'
        run: |
          cd docker-images
          docker build . \
            --file ./external/${{ matrix.component }}/Dockerfile \
            --platform 'linux/${{ matrix.architecture }}' \
            --tag 'homelab/${{ matrix.component }}:dev-${{ matrix.architecture }}'
