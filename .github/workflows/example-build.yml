name: ExampleBuild

permissions: read-all

on:
  pull_request:

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      pihole: ${{ steps.filter.outputs.pihole }}
      gatus: ${{ steps.filter.outputs.gatus }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7

      - name: Filter paths
        uses: dorny/paths-filter@v3.0.2
        id: filter
        with:
          filters: |
            pihole:
              - '**/pihole*/**'
            gatus:
              - '**/gatus*/**'

      - name: workflow tests
        if: steps.filter.outputs.${{ matrix.component }} == 'true'
        run: echo "Workflow changes"

      - name: not workflow tests
        if: steps.filter.outputs.${{ matrix.component }} != 'true'
        run: echo "NOT workflow changes"

  build:
    runs-on: ubuntu-latest
    needs: paths-filter
    # if: needs.paths-filter.outputs.${{ matrix.component }} == 'true'
    strategy:
      # fail-fast: false
      matrix:
        component:
          - pihole
          - gatus
        architecture:
          - amd64
          - arm64
    name: Build - ${{ matrix.component }} - linux/${{ matrix.architecture }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.7

      - name: Filter paths
        uses: dorny/paths-filter@v3.0.2
        id: filter
        with:
          filters: |
            pihole:
              - '**/pihole*/**'
            gatus:
              - '**/gatus*/**'

      - name: workflow tests
        if: steps.filter.outputs.${{ matrix.component }} == 'true'
        run: echo "Workflow changes"

      - name: not workflow tests
        if: steps.filter.outputs.${{ matrix.component }} != 'true'
        run: echo "NOT workflow changes"

      - name: Setup QEMU
        if: steps.filter.outputs.${{ matrix.component }} == 'true'
        uses: docker/setup-qemu-action@v3.2.0

      - name: Setup Docker Buildx
        if: steps.filter.outputs.${{ matrix.component }} == 'true'
        uses: docker/setup-buildx-action@v3.6.1

      - name: Example build
        if: steps.filter.outputs.${{ matrix.component }} == 'true'
        run: |
          cd docker-images
          docker build . \
            --file ./external/${{ matrix.component }}/Dockerfile \
            --platform 'linux/${{ matrix.architecture }}' \
            --tag 'homelab/${{ matrix.component }}:dev-${{ matrix.architecture }}'
