- name: Deploy latest homelab services
  hosts: servers
  serial: 1
  any_errors_fatal: true
  tasks:
    - name: Ping
      ansible.builtin.ping:

    - name: Initial partial deploy
      changed_when: true
      ansible.builtin.shell: |
        set -eufo pipefail

        if [ -d "$HOME/git/homelab" ]; then
          cd "$HOME/git/homelab"
        else
          printf 'Directory ~/git/homelab not found\n'
          exit 1
        fi

        if [ "$(git status --short)" != '' ]; then
          printf 'git repository is dirty\n'
          git status
          exit 1
        fi

        if [ ! -e 'servers/.current' ]; then
          printf 'Server symlink is not setup\n'
          exit 1
        fi

        cd servers/.current

        sh helper.sh deploy --dry-run --prod

    - name: Reboot
      when: docker_install.changed
      throttle: 1
      ansible.builtin.reboot:
        reboot_command: sudo reboot

    - name: Real deploy
      changed_when: true
      ansible.builtin.shell: |
        set -eufo pipefail

        if [ -d "$HOME/git/homelab" ]; then
          cd "$HOME/git/homelab"
        else
          printf 'Directory ~/git/homelab not found\n'
          exit 1
        fi

        if [ "$(git status --short)" != '' ]; then
          printf 'git repository is dirty\n'
          git status
          exit 1
        fi

        if [ ! -e 'servers/.current' ]; then
          printf 'Server symlink is not setup\n'
          exit 1
        fi

        cd servers/.current

        sh helper.sh deploy --prod
