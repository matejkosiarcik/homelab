#!/bin/sh
set -euf

tmpfile="$(mktemp)"

# web.yml
sed "s~\${PROMETHEUS_ADMIN_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS_ADMIN_PASSWORD_ENCRYPTED" | base64 -d)~g;s~\${PROMETHEUS_PROMETHEUS_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS_PROMETHEUS_PASSWORD_ENCRYPTED" | base64 -d)~g" </homelab/web.yml >"$tmpfile"
cat <"$tmpfile" >/homelab/config/web.yml

# prometheus.yml
cat </homelab/prometheus.yml |
    sed "s~\${ACTUALBUDGET_PROXY_PROMETHEUS_PASSWORD}~$ACTUALBUDGET_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${CERTBOT_PROXY_PROMETHEUS_PASSWORD}~$CERTBOT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${CHANGEDETECTION_PROXY_PROMETHEUS_PASSWORD}~$CHANGEDETECTION_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DAWARICH_PROMETHEUS_PASSWORD}~$DAWARICH_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_CACHE_PROXY_DOCKERHUB_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_CACHE_PROXY_DOCKERHUB_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOZZLE_PROXY_PROMETHEUS_PASSWORD}~$DOZZLE_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H3_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H3_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H3_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H3_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_1_PROMETHEUS_PASSWORD}~$GATUS_1_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_1_PROXY_PROMETHEUS_PASSWORD}~$GATUS_1_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_2_PROMETHEUS_PASSWORD}~$GATUS_2_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_2_PROXY_PROMETHEUS_PASSWORD}~$GATUS_2_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_ODROID_H3_PROMETHEUS_PASSWORD}~$GLANCES_ODROID_H3_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_ODROID_H3_PROXY_PROMETHEUS_PASSWORD}~$GLANCES_ODROID_H3_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD}~$GLANCES_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD}~$GLANCES_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GLANCES_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD}~$GLANCES_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GOTIFY_PROXY_PROMETHEUS_PASSWORD}~$GOTIFY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GRAFANA_PROXY_PROMETHEUS_PASSWORD}~$GRAFANA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GROCERIES_PROXY_PROMETHEUS_PASSWORD}~$GROCERIES_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HEALTHCHECKS_PROMETHEUS_PROJECT}~$HEALTHCHECKS_PROMETHEUS_PROJECT~g" |
    sed "s~\${HEALTHCHECKS_PROMETHEUS_TOKEN}~$HEALTHCHECKS_PROMETHEUS_TOKEN~g" |
    sed "s~\${HEALTHCHECKS_PROXY_PROMETHEUS_PASSWORD}~$HEALTHCHECKS_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HOME_ASSISTANT_PROMETHEUS_TOKEN}~$HOME_ASSISTANT_PROMETHEUS_TOKEN~g" |
    sed "s~\${HOME_ASSISTANT_PROXY_PROMETHEUS_PASSWORD}~$HOME_ASSISTANT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HOMEPAGE_PROXY_PROMETHEUS_PASSWORD}~$HOMEPAGE_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${JELLYFIN_PROMETHEUS_PASSWORD}~$JELLYFIN_PROMETHEUS_PASSWORD~g" |
    sed "s~\${JELLYFIN_PROXY_PROMETHEUS_PASSWORD}~$JELLYFIN_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MINIO_CONSOLE_PROXY_PROMETHEUS_PASSWORD}~$MINIO_CONSOLE_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MINIO_PROMETHEUS_TOKEN}~$MINIO_PROMETHEUS_TOKEN~g" |
    sed "s~\${MINIO_PROXY_PROMETHEUS_PASSWORD}~$MINIO_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MOTIONEYE_KITCHEN_PROXY_PROMETHEUS_PASSWORD}~$MOTIONEYE_KITCHEN_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_ODROID_H3_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_ODROID_H3_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_ODROID_H3_PROXY_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_ODROID_H3_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_ODROID_H4_ULTRA_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_ODROID_H4_ULTRA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_3B_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_3B_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_4B_2G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_4B_2G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_4B_4G_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODE_EXPORTER_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD}~$NODE_EXPORTER_RASPBERRY_PI_4B_4G_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NTFY_PROXY_PROMETHEUS_PASSWORD}~$NTFY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OLLAMA_PROXY_PROMETHEUS_PASSWORD}~$OLLAMA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OLLAMA_PRIVATE_PROXY_PROMETHEUS_PASSWORD}~$OLLAMA_PRIVATE_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OMADA_CONTROLLER_PROXY_PROMETHEUS_PASSWORD}~$OMADA_CONTROLLER_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENWEBUI_PROXY_PROMETHEUS_PASSWORD}~$OPENWEBUI_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENWEBUI_PRIVATE_PROXY_PROMETHEUS_PASSWORD}~$OPENWEBUI_PRIVATE_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENSPEEDTEST_PROXY_PROMETHEUS_PASSWORD}~$OPENSPEEDTEST_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OWNTRACKS_PROXY_PROMETHEUS_PASSWORD}~$OWNTRACKS_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_PRIMARY_PROMETHEUS_PASSWORD}~$PIHOLE_1_PRIMARY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_PRIMARY_PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_1_PRIMARY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_SECONDARY_PROMETHEUS_PASSWORD}~$PIHOLE_1_SECONDARY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_SECONDARY_PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_1_SECONDARY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_PRIMARY_PROMETHEUS_PASSWORD}~$PIHOLE_2_PRIMARY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_PRIMARY_PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_2_PRIMARY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_SECONDARY_PROMETHEUS_PASSWORD}~$PIHOLE_2_SECONDARY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_SECONDARY_PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_2_SECONDARY_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PROMETHEUS_PROMETHEUS_PASSWORD}~$PROMETHEUS_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PROMETHEUS_PROXY_PROMETHEUS_PASSWORD}~$PROMETHEUS_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${SMTP4DEV_PROXY_PROMETHEUS_PASSWORD}~$SMTP4DEV_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${TVHEADEND_PROXY_PROMETHEUS_PASSWORD}~$TVHEADEND_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_DEFAULT_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_DEFAULT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MATEJ_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_MATEJ_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MONIKA_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_MONIKA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_IOT_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_IOT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_GUESTS_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_GUESTS_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_DEFAULT_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_DEFAULT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MATEJ_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_MATEJ_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MONIKA_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_MONIKA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_IOT_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_IOT_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_GUESTS_PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_GUESTS_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNIFI_CONTROLLER_PROXY_PROMETHEUS_PASSWORD}~$UNIFI_CONTROLLER_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIME_KUMA_PROMETHEUS_PASSWORD}~$UPTIME_KUMA_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIME_KUMA_PROXY_PROMETHEUS_PASSWORD}~$UPTIME_KUMA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${VAULTWARDEN_PROXY_PROMETHEUS_PASSWORD}~$VAULTWARDEN_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${VIKUNJA_PROXY_PROMETHEUS_PASSWORD}~$VIKUNJA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${WIKIPEDIA_PROXY_PROMETHEUS_PASSWORD}~$WIKIPEDIA_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${WIKTIONARY_PROXY_PROMETHEUS_PASSWORD}~$WIKTIONARY_PROXY_PROMETHEUS_PASSWORD~g" |
    cat >"$tmpfile"
cat <"$tmpfile" >/homelab/config/prometheus.yml
rm -f "$tmpfile"

if [ "$(wc -l </homelab/config/prometheus.yml)" -eq 0 ]; then
    printf "Error: /homelab/config/prometheus.yml is empty" >&2
    exit 1
fi

promtool check web-config /homelab/config/web.yml
promtool check config /homelab/config/prometheus.yml

prometheus \
    --config.file=/homelab/config/prometheus.yml \
    --storage.tsdb.path=/prometheus \
    --storage.tsdb.retention.time=30d \
    --web.config.file=/homelab/config/web.yml
