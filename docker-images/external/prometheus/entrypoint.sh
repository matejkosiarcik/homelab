#!/bin/sh
set -euf

# web.yml
cat </homelab/web.yml |
    sed "s~\${PROMETHEUS__MATEJ_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS__MATEJ_PASSWORD_ENCRYPTED" | base64 -d)~g" |
    sed "s~\${PROMETHEUS__HOMELAB_VIEWER_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS__HOMELAB_VIEWER_PASSWORD_ENCRYPTED" | base64 -d)~g" |
    sed "s~\${PROMETHEUS__HOMELAB_TEST_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS__HOMELAB_TEST_PASSWORD_ENCRYPTED" | base64 -d)~g" |
    sed "s~\${PROMETHEUS__PROMETHEUS_PASSWORD_ENCRYPTED}~$(printf '%s' "$PROMETHEUS__PROMETHEUS_PASSWORD_ENCRYPTED" | base64 -d)~g" |
    cat >'/homelab/config/web.yml'

# prometheus.yml
cat </homelab/prometheus.yml |
    sed "s~\${ACTUALBUDGET__PROXY_PROMETHEUS_PASSWORD}~$ACTUALBUDGET__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${CERTBOT__PROXY_PROMETHEUS_PASSWORD}~$CERTBOT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${CHANGEDETECTION__PROXY_PROMETHEUS_PASSWORD}~$CHANGEDETECTION__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DAWARICH__PROMETHEUS_PASSWORD}~$DAWARICH__PROMETHEUS_PASSWORD~g" |
    sed "s~\${DAWARICH__PROXY_PROMETHEUS_PASSWORD}~$DAWARICH__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_CACHE__PROXY_DOCKERHUB_PROXY_PROMETHEUS_PASSWORD}~$DOCKER_CACHE__PROXY_DOCKERHUB_PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOZZLE__PROXY_PROMETHEUS_PASSWORD}~$DOZZLE__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H3__PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H3__PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H3__PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H3__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H4_ULTRA__PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H4_ULTRA__PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_ODROID_H4_ULTRA__PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_ODROID_H4_ULTRA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_2G__PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_2G__PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_2G__PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_2G__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_4G__PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_4G__PROMETHEUS_PASSWORD~g" |
    sed "s~\${DOCKER_STATS_RASPBERRY_PI_4B_4G__PROXY_PROMETHEUS_PASSWORD}~$DOCKER_STATS_RASPBERRY_PI_4B_4G__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_1__PROMETHEUS_PASSWORD}~$GATUS_1__PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_1__PROXY_PROMETHEUS_PASSWORD}~$GATUS_1__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_2__PROMETHEUS_PASSWORD}~$GATUS_2__PROMETHEUS_PASSWORD~g" |
    sed "s~\${GATUS_2__PROXY_PROMETHEUS_PASSWORD}~$GATUS_2__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GOTIFY__PROXY_PROMETHEUS_PASSWORD}~$GOTIFY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GRAFANA__PROXY_PROMETHEUS_PASSWORD}~$GRAFANA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${GROCERIES__PROXY_PROMETHEUS_PASSWORD}~$GROCERIES__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HEALTHCHECKS__PROMETHEUS_PROJECT}~$HEALTHCHECKS__PROMETHEUS_PROJECT~g" |
    sed "s~\${HEALTHCHECKS__PROMETHEUS_TOKEN}~$HEALTHCHECKS__PROMETHEUS_TOKEN~g" |
    sed "s~\${HEALTHCHECKS__PROXY_PROMETHEUS_PASSWORD}~$HEALTHCHECKS__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HOMEASSISTANT__PROMETHEUS_TOKEN}~$HOMEASSISTANT__PROMETHEUS_TOKEN~g" |
    sed "s~\${HOMEASSISTANT__PROXY_PROMETHEUS_PASSWORD}~$HOMEASSISTANT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${HOMEPAGE__PROXY_PROMETHEUS_PASSWORD}~$HOMEPAGE__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${JELLYFIN__PROMETHEUS_PASSWORD}~$JELLYFIN__PROMETHEUS_PASSWORD~g" |
    sed "s~\${JELLYFIN__PROXY_PROMETHEUS_PASSWORD}~$JELLYFIN__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MINIO_CONSOLE__PROXY_PROMETHEUS_PASSWORD}~$MINIO_CONSOLE__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MINIO__PROMETHEUS_TOKEN}~$MINIO__PROMETHEUS_TOKEN~g" |
    sed "s~\${MINIO__PROXY_PROMETHEUS_PASSWORD}~$MINIO__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${MOTIONEYE_KITCHEN__PROXY_PROMETHEUS_PASSWORD}~$MOTIONEYE_KITCHEN__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_ODROID_H3__PROMETHEUS_PASSWORD}~$NODEEXPORTER_ODROID_H3__PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_ODROID_H3__PROXY_PROMETHEUS_PASSWORD}~$NODEEXPORTER_ODROID_H3__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_ODROID_H4_ULTRA__PROMETHEUS_PASSWORD}~$NODEEXPORTER_ODROID_H4_ULTRA__PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_ODROID_H4_ULTRA__PROXY_PROMETHEUS_PASSWORD}~$NODEEXPORTER_ODROID_H4_ULTRA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_RASPBERRY_PI_4B_2G__PROMETHEUS_PASSWORD}~$NODEEXPORTER_RASPBERRY_PI_4B_2G__PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_RASPBERRY_PI_4B_2G__PROXY_PROMETHEUS_PASSWORD}~$NODEEXPORTER_RASPBERRY_PI_4B_2G__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_RASPBERRY_PI_4B_4G__PROMETHEUS_PASSWORD}~$NODEEXPORTER_RASPBERRY_PI_4B_4G__PROMETHEUS_PASSWORD~g" |
    sed "s~\${NODEEXPORTER_RASPBERRY_PI_4B_4G__PROXY_PROMETHEUS_PASSWORD}~$NODEEXPORTER_RASPBERRY_PI_4B_4G__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${NTFY__PROXY_PROMETHEUS_PASSWORD}~$NTFY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OLLAMA__PROXY_PROMETHEUS_PASSWORD}~$OLLAMA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OLLAMA_PRIVATE__PROXY_PROMETHEUS_PASSWORD}~$OLLAMA_PRIVATE__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OMADACONTROLLER__PROXY_PROMETHEUS_PASSWORD}~$OMADACONTROLLER__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENWEBUI__PROXY_PROMETHEUS_PASSWORD}~$OPENWEBUI__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENWEBUI_PRIVATE__PROXY_PROMETHEUS_PASSWORD}~$OPENWEBUI_PRIVATE__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${OPENSPEEDTEST__PROXY_PROMETHEUS_PASSWORD}~$OPENSPEEDTEST__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_PRIMARY__PROMETHEUS_PASSWORD}~$PIHOLE_1_PRIMARY__PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_PRIMARY__PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_1_PRIMARY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_SECONDARY__PROMETHEUS_PASSWORD}~$PIHOLE_1_SECONDARY__PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_1_SECONDARY__PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_1_SECONDARY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_PRIMARY__PROMETHEUS_PASSWORD}~$PIHOLE_2_PRIMARY__PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_PRIMARY__PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_2_PRIMARY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_SECONDARY__PROMETHEUS_PASSWORD}~$PIHOLE_2_SECONDARY__PROMETHEUS_PASSWORD~g" |
    sed "s~\${PIHOLE_2_SECONDARY__PROXY_PROMETHEUS_PASSWORD}~$PIHOLE_2_SECONDARY__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${PROMETHEUS__PROMETHEUS_PASSWORD}~$PROMETHEUS__PROMETHEUS_PASSWORD~g" |
    sed "s~\${PROMETHEUS__PROXY_PROMETHEUS_PASSWORD}~$PROMETHEUS__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${RENOVATEBOT__PROXY_PROMETHEUS_PASSWORD}~$RENOVATEBOT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${SMTP4DEV__PROXY_PROMETHEUS_PASSWORD}~$SMTP4DEV__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${TVHEADEND__PROXY_PROMETHEUS_PASSWORD}~$TVHEADEND__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_DEFAULT__PROMETHEUS_PASSWORD}~$UNBOUND_1_DEFAULT__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_DEFAULT__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_DEFAULT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_GUESTS__PROMETHEUS_PASSWORD}~$UNBOUND_1_GUESTS__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_GUESTS__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_GUESTS__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_IOT__PROMETHEUS_PASSWORD}~$UNBOUND_1_IOT__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_IOT__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_IOT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MATEJ__PROMETHEUS_PASSWORD}~$UNBOUND_1_MATEJ__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MATEJ__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_MATEJ__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MONIKA__PROMETHEUS_PASSWORD}~$UNBOUND_1_MONIKA__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_1_MONIKA__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_1_MONIKA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_DEFAULT__PROMETHEUS_PASSWORD}~$UNBOUND_2_DEFAULT__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_DEFAULT__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_DEFAULT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_GUESTS__PROMETHEUS_PASSWORD}~$UNBOUND_2_GUESTS__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_GUESTS__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_GUESTS__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_IOT__PROMETHEUS_PASSWORD}~$UNBOUND_2_IOT__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_IOT__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_IOT__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MATEJ__PROMETHEUS_PASSWORD}~$UNBOUND_2_MATEJ__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MATEJ__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_MATEJ__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MONIKA__PROMETHEUS_PASSWORD}~$UNBOUND_2_MONIKA__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNBOUND_2_MONIKA__PROXY_PROMETHEUS_PASSWORD}~$UNBOUND_2_MONIKA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UNIFICONTROLLER__PROXY_PROMETHEUS_PASSWORD}~$UNIFICONTROLLER__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIMEKUMA_1__PROMETHEUS_PASSWORD}~$UPTIMEKUMA_1__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIMEKUMA_2__PROMETHEUS_PASSWORD}~$UPTIMEKUMA_2__PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIMEKUMA_1__PROXY_PROMETHEUS_PASSWORD}~$UPTIMEKUMA_1__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${UPTIMEKUMA_2__PROXY_PROMETHEUS_PASSWORD}~$UPTIMEKUMA_2__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${VAULTWARDEN__PROXY_PROMETHEUS_PASSWORD}~$VAULTWARDEN__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${VIKUNJA__PROXY_PROMETHEUS_PASSWORD}~$VIKUNJA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${WIKIPEDIA__PROXY_PROMETHEUS_PASSWORD}~$WIKIPEDIA__PROXY_PROMETHEUS_PASSWORD~g" |
    sed "s~\${WIKTIONARY__PROXY_PROMETHEUS_PASSWORD}~$WIKTIONARY__PROXY_PROMETHEUS_PASSWORD~g" |
    cat >'/homelab/config/prometheus.yml'

if [ "$(wc -l </homelab/config/prometheus.yml)" -eq 0 ]; then
    printf "Error: /homelab/config/prometheus.yml is empty" >&2
    exit 1
fi

promtool check web-config /homelab/config/web.yml
promtool check config /homelab/config/prometheus.yml

prometheus \
    --config.file=/homelab/config/prometheus.yml \
    --storage.tsdb.path=/prometheus \
    --storage.tsdb.retention.time=30d \
    --web.config.file=/homelab/config/web.yml
