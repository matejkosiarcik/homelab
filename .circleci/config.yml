version: 2.1

workflows:
  version: 2
  circleci:
    jobs:
      - azlint
      - build_containers
      - dry_deployment

jobs:
  azlint:
    docker:
      - image: matejkosiarcik/azlint:0.6.11
    steps:
      - checkout
      - run: |
          azlint
          # TODO: Reenable code below
          # if [ "$CIRCLE_BRANCH" = main ]; then
          #   azlint
          # else
          #   azlint --only-changed
          # fi

  build_containers:
    docker:
      - image: docker:26.0.2
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build pi-hole backup container
          working_directory: ./machines/raspberrypi-3b/pi-hole/backup
          command: docker build .
      - run:
          name: Build healthchecks backup container
          working_directory: ./machines/odroid-h3/healthchecks/backup
          command: docker build .
      - run:
          name: Build unifi-network-application backup container
          working_directory: ./machines/odroid-h3/unifi-network-application/backup
          command: docker build .

  dry_deployment:
    docker:
      - image: docker:26.0.2
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Install system dependencies
          command: |
            apk update --no-cache
            apk add --no-cache bash git
      - run:
          name: Run deployment on Raspberry Pi 3B [dry-run]
          command: |
            mkdir -p "$PWD/.deployment/raspberrypi-3b/pi-hole/private"
            touch "$PWD/.deployment/raspberrypi-3b/pi-hole/private/app-backup.env"
            DEST_DIR="$PWD/.deployment/raspberrypi-3b" \
              bash './machines/raspberrypi-3b/install.sh' -n
      - run:
          name: Run deployment on Odroid H3 [dry-run]
          command: |
            mkdir -p "$PWD/.deployment/odroid-h3/healthchecks/private" \
              "$PWD/.deployment/odroid-h3/unifi-network-application/private"
            touch "$PWD/.deployment/odroid-h3/healthchecks/private/healthchecks.env" \
              "$PWD/.deployment/odroid-h3/healthchecks/private/postgres-backup.env" \
              "$PWD/.deployment/odroid-h3/unifi-network-application/private/app-backup.env"
            DEST_DIR="$PWD/.deployment/odroid-h3" \
              bash './machines/odroid-h3/install.sh' -n
