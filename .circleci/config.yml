version: 2.1

workflows:
  version: 2
  circleci:
    jobs:
      - azlint
      - local_build
      - docker_build
      - deployment

jobs:
  azlint:
    docker:
      - image: matejkosiarcik/azlint:0.6.13
    steps:
      - checkout
      - run: |
          azlint
          # TODO: Reenable code below
          # if [ "$CIRCLE_BRANCH" = main ]; then
          #   azlint
          # else
          #   azlint --only-changed
          # fi

  local_build:
    docker:
      - image: debian:12.6
    steps:
      - checkout
      - run:
          name: Install system dependencies
          command: |
            apt-get update -qq
            DEBIAN_FRONTEND=noninteractive DEBCONF_TERSE=yes DEBCONF_NOWARNINGS=yes \
              apt-get install -q --yes --no-install-recommends \
              ca-certificates git make \
              nodejs npm \
              python3 python3-pip python3-venv
      - run:
          name: Install project dependencies
          command: make bootstrap
      - run:
          name: Build subprojects
          command: make build

  docker_build:
    docker:
      - image: docker:27.1.2
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Install system dependencies
          command: |
            apk update --no-cache
            apk add --no-cache make
      - run:
          name: Build docker
          command: |
            make docker-build

  deployment:
    docker:
      - image: docker:27.1.2
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Install system dependencies
          command: |
            apk update --no-cache
            apk add --no-cache apache2-utils bash git moreutils python3
      - run:
          name: Run deployment on Raspberry Pi 3B [dev]
          command: |
            bash './servers/raspberry-pi-3b/helper.sh' create-secrets --dev --force
            bash './servers/raspberry-pi-3b/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Raspberry Pi 3B [prod]
          command: |
            bash './servers/raspberry-pi-3b/helper.sh' create-secrets --prod --force
            bash './servers/raspberry-pi-3b/helper.sh' start --prod --dry-run
      - run:
          name: Run deployment on Raspberry Pi 4B 2G [dev]
          command: |
            bash './servers/raspberry-pi-4b-2g/helper.sh' create-secrets --dev --force
            bash './servers/raspberry-pi-4b-2g/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Raspberry Pi 4B 2G [prod]
          command: |
            bash './servers/raspberry-pi-4b-2g/helper.sh' create-secrets --prod --force
            bash './servers/raspberry-pi-4b-2g/helper.sh' start --prod --dry-run
      - run:
          name: Run deployment on Raspberry Pi 4B 4G [dev]
          command: |
            bash './servers/raspberry-pi-4b-4g/helper.sh' create-secrets --dev --force
            bash './servers/raspberry-pi-4b-4g/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Raspberry Pi 4B 4G [prod]
          command: |
            bash './servers/raspberry-pi-4b-4g/helper.sh' create-secrets --prod --force
            bash './servers/raspberry-pi-4b-4g/helper.sh' start --prod --dry-run
      - run:
          name: Run deployment on Raspberry Pi Zero 2w [1] [dev]
          command: |
            bash './servers/raspberry-pi-zero-2w-1/helper.sh' create-secrets --dev --force
            bash './servers/raspberry-pi-zero-2w-1/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Raspberry Pi Zero 2w [1] [prod]
          command: |
            bash './servers/raspberry-pi-zero-2w-1/helper.sh' create-secrets --prod --force
            bash './servers/raspberry-pi-zero-2w-1/helper.sh' start --prod --dry-run
      - run:
          name: Run deployment on Raspberry Pi Zero 2w [2] [dev]
          command: |
            bash './servers/raspberry-pi-zero-2w-2/helper.sh' create-secrets --dev --force
            bash './servers/raspberry-pi-zero-2w-2/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Raspberry Pi Zero 2w [2] [prod]
          command: |
            bash './servers/raspberry-pi-zero-2w-2/helper.sh' create-secrets --prod --force
            bash './servers/raspberry-pi-zero-2w-2/helper.sh' start --prod --dry-run
      - run:
          name: Run deployment on Odroid H3 [dev]
          command: |
            bash './servers/odroid-h3/helper.sh' create-secrets --dev --force
            bash './servers/odroid-h3/helper.sh' start --dev --dry-run
      - run:
          name: Run deployment on Odroid H3 [prod]
          command: |
            bash './servers/odroid-h3/helper.sh' create-secrets --prod --force
            bash './servers/odroid-h3/helper.sh' start --prod --dry-run
