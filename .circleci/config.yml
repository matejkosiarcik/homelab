version: 2.1

workflows:
  version: 2
  circleci:
    jobs:
      - azlint
      - dry_deployment

jobs:
  azlint:
    docker:
      - image: matejkosiarcik/azlint:0.6.11
    steps:
      - checkout
      - run: |
          if [ "$CIRCLE_BRANCH" = main ]; then
            azlint
          else
            azlint --only-changed
          fi

  dry_deployment:
    docker:
      - image: debian:12.5
    steps:
      - checkout
      - run:
          name: Install system dependencies
          command: |
            apt-get update -qq
            DEBIAN_FRONTEND=noninteractive DEBCONF_TERSE=yes DEBCONF_NOWARNINGS=yes \
              apt-get install -q --yes --no-install-recommends bash git
      - run:
          name: Run deployment on Raspberry Pi 3B [dry-run]
          command: |
            DEST_DIR="$PWD/.deployment" \
              bash './machines/raspberrypi-3b/install.sh' -n
      - run:
          name: Run deployment on Odroid H3 [dry-run]
          command: |
            DEST_DIR="$PWD/.deployment" \
              bash './machines/odroid-h3/install.sh' -n
