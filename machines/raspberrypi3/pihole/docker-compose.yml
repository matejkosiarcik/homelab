# version: "3.8"

services:
  pihole-app:
    image: pihole-app:homelab
    build:
      context: ../../../components/pihole/
    container_name: pihole-app
    hostname: pihole-app
    volumes:
      - ./data/etc-pihole:/etc/pihole:rw
      - ./data/etc-dnsmasq.d:/etc/dnsmasq.d:rw
      - ./private/webpassword.txt:/.homelab/webpassword.txt:ro
    stop_grace_period: 30s

  pihole-http-proxy:
    image: pihole-http-proxy:homelab
    build:
      context: ../../../components/http-proxy
    container_name: pihole-http-proxy
    hostname: pihole-http-proxy
    environment:
      - HOST=pihole.lan
      - UPSTREAM_URL=http://pihole-app
      - HOMELAB_SERVICE=pihole
    volumes:
      - ./log/proxy-access:/log/access:rw
      - ./log/proxy-error:/log/error:rw
      - ./log/proxy-forensic:/log/forensic:rw
      - ./private/certs:/certs:ro
      - ./private/status.htpasswd:/app/misc/status.htpasswd:ro

  pihole-socat:
    image: pihole-socat:homelab
    build:
      context: ../../../components/socat/
    container_name: pihole-socat
    hostname: pihole-socat
    volumes:
      - ./config/socat/main.sh:/app/main.sh:ro

  pihole-webui-backup:
    image: pihole-backup:homelab
    build:
      context: ../../../components/webui-backup/
    container_name: pihole-backup
    hostname: pihole-backup
    depends_on:
      pihole-app:
        condition: service_healthy
    env_file:
      - ./private/app-backup.env
    volumes:
      - ./data/webui-backup:/backup:rw
      - ./log/webui-backup:/log:rw
      - ./config/webui-backup/main.sh:/app/main.sh:ro

networks:
  pihole-external-network:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: "10.1.0.0/19"
          ip_range: "10.1.10.0/24"
          gateway: "10.1.0.1"

  pihole-internal-network:
