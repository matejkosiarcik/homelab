# version: "3.8"

x-definitions:
  common-env-variables: &common-env-variables
    HOMELAB_APP_TYPE: pihole
    HOMELAB_APP_SUBTYPE: pihole-main
    HOMELAB_APP_EXTERNAL_DOMAIN: pihole-main.home

services:
  app:
    image: pihole-main-app:homelab
    build:
      context: ../../../../components/
      dockerfile: ./external/pihole/Dockerfile
    container_name: pihole-main-app
    hostname: pihole-main-app
    environment:
      <<: *common-env-variables
    volumes:
      - ./data/pihole/etc-pihole:/etc/pihole:rw
      - ./data/pihole/etc-dnsmasq.d:/etc/dnsmasq.d:rw
      - ./private/webpassword.txt:/.homelab/webpassword.txt:ro
      - ../../../../components/external/pihole/custom-domains.txt:/etc/pihole/custom.list:ro
    stop_grace_period: 30s

  certificate-manager:
    image: pihole-main-certificate-manager:homelab
    build:
      context: ../../../../components/
      dockerfile: ./custom/certificate-manager/Dockerfile
    container_name: pihole-main-certificate-manager
    hostname: pihole-main-certificate-manager
    environment:
      <<: *common-env-variables
    volumes:
      - ./data/certs:/certs:rw
      - ./log/certificate-manager:/log:rw

  http-proxy:
    image: pihole-main-http-proxy:homelab
    build:
      context: ../../../../components/
      dockerfile: ./custom/http-proxy/Dockerfile
    container_name: pihole-main-http-proxy
    hostname: pihole-main-http-proxy
    depends_on:
      certificate-manager:
        condition: service_healthy
    environment:
      <<: *common-env-variables
    volumes:
      - ./log/proxy-access:/log/access:rw
      - ./log/proxy-error:/log/error:rw
      - ./log/proxy-forensic:/log/forensic:rw
      - ./data/certs:/certs:ro
      - ./private/status.htpasswd:/app/misc/status.htpasswd:ro

  socket-proxy:
    image: pihole-main-socket-proxy:homelab
    build:
      context: ../../../../components/
      dockerfile: ./custom/socket-proxy/Dockerfile
    container_name: pihole-main-socket-proxy
    hostname: pihole-main-socket-proxy
    environment:
      <<: *common-env-variables

  webui-backup:
    image: pihole-main-webui-backup:homelab
    build:
      context: ../../../../components/
      dockerfile: ./custom/webui-backup/Dockerfile
    container_name: pihole-main-webui-backup
    hostname: pihole-main-webui-backup
    depends_on:
      app:
        condition: service_healthy
    environment:
      <<: *common-env-variables
    volumes:
      - ./private/webui-backup.env:/app/.env:ro
      - ./data/webui-backup:/backup:rw
      - ./log/webui-backup:/log:rw

networks:
  external-network:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: "10.1.0.0/19"
          ip_range: "10.1.10.0/24"
          gateway: "10.1.6.201"

  internal-network:
