services:
  main-app:
    image: healthchecks-app:homelab
    build:
      context: ../../../../docker-images/
      dockerfile: ./external/healthchecks/Dockerfile
    container_name: healthchecks-app
    hostname: healthchecks-app
    depends_on:
      database:
        condition: service_healthy
    env_file:
      - ./private/app.env
    environment:
      - SITE_NAME=Healthchecks
      - DB_HOST=healthchecks-database
    stop_grace_period: 30s

  database:
    image: healthchecks-database:homelab
    build:
      context: ../../../../docker-images/
      dockerfile: ./database/postgres/Dockerfile
    container_name: healthchecks-database
    hostname: healthchecks-database
    volumes:
      - ./data/database-data:/var/lib/postgresql/data:rw
      - ./private/database-password.txt:/.homelab/password.txt:ro
    stop_grace_period: 30s

  database-backup:
    image: healthchecks-database-backup:homelab
    build:
      context: ../../../../docker-images/
      dockerfile: ./custom/postgres-backup/Dockerfile
    container_name: healthchecks-database-backup
    hostname: healthchecks-database-backup
    depends_on:
      database:
        condition: service_healthy
    env_file:
      - ./private/database-backup.env
    environment:
      - PGHOST=healthchecks-database
      - HOMELAB_APP_TYPE=healthchecks
    volumes:
      - ./data/database-backup:/backup:rw
      - ./log/database-backup:/log:rw

networks:
  external-network:
    driver: macvlan
    driver_opts:
      parent: eth0
    ipam:
      config:
        - subnet: "10.1.0.0/19"
          ip_range: "10.1.11.0/24"
          gateway: "10.1.0.1"

  internal-network:
